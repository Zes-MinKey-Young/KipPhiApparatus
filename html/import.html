<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="/css/formpage.css">
<title>Import a chart - KPA</title>
</head>
<body>
    <h1>Import a Chart</h1>
    <p>Tips: 谱面标识符用于索引谱面，请尽量选择易于记忆的简短的不含中文的字符串<br>
        Tips: Chart Identifiers are used to index charts, please use strings that are easy to memorize.</p>
    <p>导入的谱面可以是<a href="https://pgrfm.miraheze.org/wiki/RPEJSON">RPEJSON</a>谱面也可以是<a href="https://pgrfm.miraheze.org/wiki/KPAJSON">KPAJSON</a>谱面<br>You can import either RPEJSON or KPAJSON.</p>
    <p>请选择插图、音乐和谱面文件，或上传一个压缩包。<br>Choose illustration, music and chart files, or upload a PEZ(ZIP) Archive.</p>
    <form action="/import" method="POST" enctype="multipart/form-data">
        <label for="id">Identifier</label>
        <input type="text" name="id" id="id" placeholder="Id">
        <label for="compression">PEZ File</label>
        <input type="file" name="compression" id="compression">
        <label for="illustration">Illustration</label>
        <input type="file" name="illustration" id="illustration">
        <label for="music">Music</label>
        <input type="file" name="music" id="music">
        <label for="chart">Chart</label>
        <input type="file" name="chart" id="chart">
        <input type="submit" value="Create"></input>
    </form>
    
    <script>
        const nameInput = document.getElementById("id");
        const chartInput = document.getElementById("chart");
        const musicInput = document.getElementById("music");
        const illustrationInput = document.getElementById("illustration");
        const compressionInput = document.getElementById("compression");
        compressionInput.addEventListener("change", (_e) => {
            if (compressionInput.files[0]) {
                chartInput.disabled = true;
                musicInput.disabled = true;
                illustrationInput.disabled = true;
            } else {
                chartInput.disabled = false;
                musicInput.disabled = false;
                illustrationInput.disabled = false;
            }
        });
        for (const input of [nameInput, chartInput, musicInput, illustrationInput]) {
            input.addEventListener("change", (_e) => {
                if (input.files[0]) {
                    compressionInput.disabled = true;
                } else {
                    compressionInput.disabled = false;
                }
            });
        }
        let supportsServer = false;
        fetch("/status")
            .then(res => {
                if (res.status !== 204) {
                    alert("无服务器状态不支持“导入谱面");
                    location.href = "/";
                }
                return supportsServer = res.status === 204;
            })
        document.querySelector("form").addEventListener("submit", function (e) {
            if (nameInput.value.trim() === "") {
                e.preventDefault();
                alert("请填写谱面标识符");
                return;
            }
            const compression = compressionInput.files[0];
            if (compression) {
                return;
            }
            const music = musicInput.files[0];
    
            const illustration = illustrationInput.files[0];

            const chart = chartInput.files[0];
    
            if (!illustration || !music || !chart) {
                e.preventDefault();
                alert("请选择插图、音乐和谱面文件，或上传一个压缩包");
                return;
            }

        });
    </script>
</body>
</html>